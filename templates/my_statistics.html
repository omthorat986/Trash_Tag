<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Statistics - CleanSnap</title>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --green: #059669;
    --light-green: #d1fae5;
    --bg: #f4f6f9;
    --white: #fff;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Poppins', 'Segoe UI', sans-serif;
    background: linear-gradient(145deg, #e8f5ec, #f7fafc);
    color: #333;
    overflow-x: hidden;
    padding: 0;
  }

  header {
    background: linear-gradient(135deg, #059669, #047857);
    color: white;
    padding: 25px 40px;
    box-shadow: 0 6px 20px rgba(5, 150, 105, 0.3);
    animation: slideDown 1s ease-out;
  }

  header h1 {
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 1px;
    margin: 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 50px 25px;
    animation: fadeIn 1.2s ease-out;
  }

  h1 {
    text-align: center;
    color: #064635;
    font-size: 2.2rem;
    margin-bottom: 50px;
    font-weight: 700;
    animation: fadeUp 0.8s ease-in-out;
  }

  h2 {
    color: #064635;
    font-size: 1.8rem;
    margin-top: 60px;
    margin-bottom: 30px;
    font-weight: 600;
    border-bottom: 3px solid var(--green);
    padding-bottom: 15px;
    animation: fadeUp 1s ease-in-out;
  }

  .stats {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 40px;
  }

  .card {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(8px);
    padding: 30px 25px;
    border-radius: 18px;
    box-shadow: var(--shadow);
    flex: 1 1 250px;
    text-align: center;
    border: 1px solid rgba(5, 150, 105, 0.1);
    transition: all 0.3s ease;
    animation: popUp 0.8s ease forwards;
    opacity: 0;
  }

  .card:nth-child(1) { animation-delay: 0.2s; }
  .card:nth-child(2) { animation-delay: 0.4s; }
  .card:nth-child(3) { animation-delay: 0.6s; }
  .card:nth-child(4) { animation-delay: 0.8s; }

  .card:hover {
    transform: translateY(-12px);
    box-shadow: 0 15px 35px rgba(5, 150, 105, 0.25);
  }

  .card h3 {
    color: var(--green);
    margin-bottom: 15px;
    font-weight: 600;
    font-size: 1rem;
  }

  .card p {
    font-size: 2rem;
    font-weight: 700;
    color: #064635;
    margin: 0;
  }

  .progress-section {
    margin-top: 50px;
    animation: fadeUp 1s ease-in-out;
  }

  .progress-label {
    font-size: 1rem;
    margin-bottom: 15px;
    text-align: center;
    font-weight: 500;
    color: #475569;
  }

  .progress-bar {
    background: #e2e8f0;
    border-radius: 25px;
    overflow: hidden;
    height: 30px;
    box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .progress-fill {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    color: white;
    text-align: center;
    line-height: 30px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 0.9rem;
    animation: fillBar 2.5s ease-out forwards;
    box-shadow: 0 0 10px rgba(5, 150, 105, 0.4);
  }

  @keyframes fillBar {
    from { width: 0%; }
    to { width: var(--progress-width); }
  }

  .chart-section {
    margin-top: 60px;
    animation: fadeUp 1.1s ease-in-out;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(8px);
    padding: 30px;
    border-radius: 18px;
    box-shadow: var(--shadow);
  }

  canvas {
    max-width: 100%;
    border-radius: 12px;
  }

  .timeline {
    margin-top: 70px;
    animation: fadeUp 1.2s ease-in-out;
  }

  .timeline-entry {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(8px);
    padding: 20px 25px;
    margin-bottom: 15px;
    border-radius: 12px;
    border-left: 5px solid var(--green);
    box-shadow: var(--shadow);
    animation: slideIn 0.6s ease forwards;
    opacity: 0;
    transform: translateX(-20px);
  }

  .timeline-entry:nth-child(1) { animation-delay: 0.2s; }
  .timeline-entry:nth-child(2) { animation-delay: 0.4s; }
  .timeline-entry:nth-child(3) { animation-delay: 0.6s; }
  .timeline-entry:nth-child(4) { animation-delay: 0.8s; }

  .timeline-entry h4 {
    color: #064635;
    margin: 0 0 5px 0;
    font-size: 1.1rem;
  }

  .timeline-entry span {
    color: #64748b;
    font-size: 0.9rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-top: 20px;
    animation: riseUp 1s ease forwards;
    opacity: 0;
  }

  th, td {
    padding: 15px 20px;
    text-align: left;
    font-weight: 500;
  }

  th {
    background: linear-gradient(135deg, #059669, #047857);
    color: white;
    font-weight: 600;
  }

  tbody tr:nth-child(even) {
    background: #f8f9fa;
  }

  tbody tr:hover {
    background: #e8f5ec;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .leaderboard-section {
    margin-top: 70px;
    animation: fadeUp 1.3s ease-in-out;
  }

  /* --- Animations --- */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideIn {
    to { opacity: 1; transform: translateX(0); }
  }

  @keyframes slideDown {
    from { transform: translateY(-60px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @keyframes popUp {
    to { opacity: 1; transform: translateY(0); }
    from { opacity: 0; transform: translateY(40px); }
  }

  @keyframes riseUp {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .container { padding: 30px 15px; }
    .stats { flex-direction: column; align-items: stretch; }
    .card { width: 100%; }
    h1 { font-size: 1.8rem; }
    h2 { font-size: 1.4rem; }
  }
</style>
</head>
<body>

<header>
  <h1>üìä My Statistics</h1>
  <a href="{% if current_user.role == 'cleaner' %}{{ url_for('cleaner_dashboard') }}{% else %}{{ url_for('user_dashboard') }}{% endif %}" style="color: white; text-decoration: none; font-weight: 600; position: absolute; right: 25px; top: 18px;">‚Üê Back to Dashboard</a>
</header>

<div class="container">
<h1>Your Eco Impact Dashboard</h1>

<!-- Stats Cards -->
<div class="stats">
  <div class="card">
    <h3>üßπ Total Cleanups</h3>
    <p>{{ total_cleanups }}</p>
  </div>
  <div class="card">
    <h3>‚≠ê EcoCoins Earned</h3>
    <p>{{ current_user.points or 0 }} ‚Çë‚Çµ</p>
  </div>
  <div class="card">
    <h3>üèÜ Your Rank</h3>
    <p>#{{ rank or 'TBD' }}</p>
  </div>
  <div class="card">
    <h3>üìà Yearly Goal</h3>
    <div class="progress-bar">
      <div class="progress-fill" style="--progress-width: {{ goal_progress or 0 }}%;">{{ goal_progress or 0 }}%</div>
    </div>
  </div>
</div>

<!-- Progress Section -->
<div class="progress-section">
  <div class="progress-label">üéØ Your Yearly Impact Progress: <strong>{{ goal_progress or 0 }}%</strong></div>
  <div class="progress-bar">
    <div class="progress-fill" style="--progress-width: {{ goal_progress or 0 }}%;">{{ goal_progress or 0 }}%</div>
  </div>
</div>

<!-- Chart Section -->
<div class="chart-section">
  <h2>üìä Monthly Cleanup Counts</h2>
  <canvas id="monthlyChart"></canvas>
</div>

<!-- Timeline / Recent Activities -->
<div class="timeline">
  <h2>üìÖ Recent Activities</h2>
  {% for report in recent_activities[:5] %}
    <div class="timeline-entry">
      <h4>üßπ {{ report.location }}</h4>
      <span>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }} ‚Ä¢ {{ report.status }}</span>
    </div>
  {% else %}
    <div class="timeline-entry">
      <h4>No recent activities</h4>
      <span>Start by recording your first cleanup!</span>
    </div>
  {% endfor %}
</div>

<!-- Leaderboard Section -->
<div class="leaderboard-section">
  <h2>üèÜ Top 5 Cleaners</h2>
  <canvas id="leaderboardChart"></canvas>
</div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const socket = io();
    const CURRENT_USER_ID = {{ current_user.id }};

    socket.on("connect", () => {
        console.log("[INFO] Connected to Socket.IO for stats updates");
        socket.emit("join_cleaners");
    });

    socket.on("stats_updated", data => {
        if (data.user_id === CURRENT_USER_ID) {
            console.log("[INFO] Stats updated, reloading...");
            location.reload();
        }
    });

    // Monthly Cleanup Chart with Animations
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: {{ monthly_counts.keys()|list|tojson }},
            datasets: [{
                label: 'Cleanups Completed',
                data: {{ monthly_counts.values()|list|tojson }},
                backgroundColor: 'rgba(5, 150, 105, 0.8)',
                borderColor: 'rgba(5, 150, 105, 1)',
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: 'rgba(5, 150, 105, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(5, 150, 105, 0.9)',
                    padding: 12,
                    borderRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#064635',
                        font: { weight: 500 }
                    },
                    grid: { color: '#e2e8f0' }
                },
                x: {
                    ticks: { color: '#064635', font: { weight: 500 } },
                    grid: { display: false }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });

    // Leaderboard Chart with Animations
    const leaderboardCtx = document.getElementById('leaderboardChart').getContext('2d');
    new Chart(leaderboardCtx, {
        type: 'bar',
        data: {
            labels: {{ leaderboard|map(attribute='username')|list|tojson }},
            datasets: [{
                label: 'EcoCoins',
                data: {{ leaderboard|map(attribute='points')|list|tojson }},
                backgroundColor: [
                    'rgba(5, 150, 105, 0.9)',
                    'rgba(5, 150, 105, 0.8)',
                    'rgba(5, 150, 105, 0.7)',
                    'rgba(5, 150, 105, 0.6)',
                    'rgba(5, 150, 105, 0.5)'
                ],
                borderColor: 'rgba(5, 150, 105, 1)',
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: 'rgba(5, 150, 105, 1)'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(5, 150, 105, 0.9)',
                    padding: 12,
                    borderRadius: 8
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        color: '#064635',
                        font: { weight: 500 }
                    },
                    grid: { color: '#e2e8f0' }
                },
                y: {
                    ticks: { color: '#064635', font: { weight: 500 } },
                    grid: { display: false }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
});
</script>

</body>
</html>

